{% extends "auctions/layout.html" %}
{% load static %}

{% block extra_css %}
    <link href="{% static 'auctions/listing.css' %}" rel="stylesheet">
{% endblock %}

{% block body %}
    <div class="listing-detail-card">
        <div class="listing-detail-image">
            {% if listing.image_url %}
                <img src="{{ listing.image_url }}" alt="{{ listing.title }}" />
            {% else %}
                <img src="https://www.freeiconspng.com/thumbs/no-image-icon/no-image-icon-6.png" alt="No image" />
            {% endif %}
        </div>
        <div class="listing-detail-info">
            <div class="listing-header">
                <h2>{{ listing.title }}</h2>
                <div class="listing-actions">
                    {% if user.is_authenticated %}
                        <form method="post" action="{% url is_watchlisted|yesno:'remove_from_watchlist,add_to_watchlist' listing.id %}">
                            {% csrf_token %}
                            {% if is_watchlisted %}
                                <button type="submit" class="watchlist-btn remove">Remove from Watchlist</button>
                            {% else %}
                                <button type="submit" class="watchlist-btn add">Add to Watchlist</button>
                            {% endif %}
                        </form>
                    {% endif %}
                    {% if user.is_authenticated and user == listing.owner and listing.is_active %}
                        <form method="post" action="{% url 'close_auction' listing.id %}" style="margin-left:10px;">
                            {% csrf_token %}
                            <button type="submit" class="delete-btn">Close Auction</button>
                        </form>
                    {% endif %}
                </div>
            </div>
            <p>{{ listing.description|linebreaksbr }}</p>
            <p><strong>Category:</strong> {{ listing.category.name }}</p>
            <p><strong>Starting bid:</strong> ${{ listing.starting_bid }}</p>
            <p><strong>Owner:</strong> {{ listing.owner.username }}</p>
            <p><strong>Created at:</strong> {{ listing.created_at }}</p>
            <p><strong>Status:</strong> {% if listing.is_active %}Active{% else %}Closed{% endif %}</p>
            <p><strong>Current price:</strong> ${{ listing.get_current_price|floatformat:2 }}</p>

            <!-- Bidding Form -->
            {% if user.is_authenticated and listing.is_active %}
                <form method="post" action="{% url 'bid' listing.id %}" style="margin-top:15px;">
                    {% csrf_token %}
                    <label for="bid_amount"><strong>Place a bid:</strong></label>
                    <input type="number" step="0.01" min="{{ listing.get_current_price }}" name="bid_amount" id="bid_amount" required>
                    <button type="submit" class="bid-btn">Bid</button>
                </form>
                {% if bid_error %}
                    <p class="error" style="color:red;">{{ bid_error }}</p>
                {% endif %}
            {% endif %}


             {% if user.is_authenticated and not listing.is_active and listing.get_auction_winner == user %}
                <p>Congratulations! You are the auction winner!</p>
             {% endif %}


        </div>
    </div>

    <!-- Comments Section -->
    <div class="comments-section">
        <h3>Comments</h3>
        {% if listing.comments.all %}
            <ul class="comments-list">
                {% for comment in listing.comments.all %}
                    <li>
                        <strong>{{ comment.commenter.username }}</strong> ({{ comment.created_at }}):<br>
                        {{ comment.text }}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No comments yet.</p>
        {% endif %}

        {% if user.is_authenticated %}
            <form method="post" action="{% url 'add_comment' listing.id %}" class="add-comment-form" style="margin-top:15px;">
            {% csrf_token %}
            <label for="comment_text"><strong>Add a comment:</strong></label><br>
            <textarea name="comment_text" id="comment_text" rows="3" required></textarea><br>
            <button type="submit" class="comment-btn">Post Comment</button>
            </form>
            {% if comment_error %}
            <p class="error" style="color:red;">{{ comment_error }}</p>
            {% endif %}
        {% else %}
            <p><a href="{% url 'login' %}">Log in</a> to post a comment.</p>
        {% endif %}
    </div>
{% endblock %}